<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chord Craft</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body class="bg-slate-950 text-slate-100">
  <div id="app" class="max-w-6xl mx-auto px-4 py-6">
    <header class="flex items-center justify-between gap-4 mb-6">
      <div>
        <p class="text-sm text-slate-400">スケールとコード進行を管理するシングルページアプリ</p>
        <h1 class="text-3xl font-bold">Chord Craft</h1>
      </div>
      <div class="flex gap-2 text-sm text-slate-400">
        <span class="px-2 py-1 bg-slate-800 rounded border border-slate-700">Vue 3 SPA</span>
        <span class="px-2 py-1 bg-slate-800 rounded border border-slate-700">FastAPI</span>
        <span class="px-2 py-1 bg-slate-800 rounded border border-slate-700">Docker Ready</span>
      </div>
    </header>

    <main class="space-y-6">
      <section class="p-4 rounded-lg bg-slate-900 border border-slate-800">
        <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <span class="w-2 h-2 bg-sky-400 rounded-full"></span> コード進行
          </h2>
          <div class="flex items-center gap-2 text-sm text-slate-300">
            <input v-model="progressionName" type="text" placeholder="進行名" class="bg-slate-800 border border-slate-700 rounded px-3 py-2" />
            <button @click="saveProgression" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded shadow">保存</button>
            <button v-if="currentProgressionId" @click="resetProgression" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded">新規</button>
          </div>
        </div>
        <div v-if="chords.length === 0" class="text-sm text-slate-400">進行にコードがありません。左のフォームから追加してください。</div>
        <div v-else class="grid sm:grid-cols-2 md:grid-cols-3 gap-3">
          <div
            v-for="(chord, idx) in chords"
            :key="idx"
            class="p-3 rounded border border-slate-800 bg-slate-800/70 space-y-2"
          >
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs text-slate-400">{{ degreeLabel(chord) }}</p>
                <p class="text-lg font-semibold">{{ chord.label }}</p>
              </div>
              <div class="flex gap-1">
                <button @click="startEdit(idx)" class="px-2 py-1 text-xs rounded bg-amber-500/80 text-slate-900">編集</button>
                <button @click="removeChord(idx)" class="px-2 py-1 text-xs rounded bg-rose-500/80 text-slate-900">削除</button>
              </div>
            </div>
            <div class="flex gap-1 text-xs text-slate-300">
              <button @click="moveChord(idx, -1)" class="flex-1 px-2 py-1 rounded bg-slate-800 border border-slate-700">◀︎</button>
              <button @click="moveChord(idx, 1)" class="flex-1 px-2 py-1 rounded bg-slate-800 border border-slate-700">▶︎</button>
            </div>
            <div class="space-y-2 text-xs text-slate-200">
              <div class="flex items-center justify-between">
                <span class="text-slate-300">フォーム</span>
                <button
                  class="px-2 py-1 rounded bg-sky-600/80 hover:bg-sky-500 text-slate-50 text-[11px]"
                  @click="openShapeDialog(chord.label)"
                >
                  フォーム登録
                </button>
              </div>
              <div v-if="shapesForLabel(chord.label).length === 0" class="text-slate-400">未登録です。</div>
              <div v-else class="space-y-2">
                <div
                  v-for="shape in shapesForLabel(chord.label)"
                  :key="shape.id"
                  class="p-2 rounded border border-slate-700 bg-slate-900/70"
                >
                  <div class="flex items-center justify-between mb-1">
                    <p class="font-semibold text-slate-100">{{ shape.position || 'ポジション未設定' }}</p>
                    <button
                      class="text-[11px] px-2 py-1 rounded bg-amber-500/80 text-slate-900"
                      @click="editShape(shape)"
                    >
                      編集
                    </button>
                  </div>
                  <div class="flex justify-between text-[11px] text-slate-400 mb-1">
                    <span>開始フレット: {{ shape.diagram.startFret }}F</span>
                    <span>コード: {{ shape.chord }}</span>
                  </div>
                  <div class="space-y-2">
                    <div class="grid grid-cols-6 gap-1 text-[10px] text-slate-400">
                      <span class="text-right pr-1">弦</span>
                      <template v-for="fretNum in visualFrets(shape)" :key="fretNum">
                        <span class="text-center">{{ fretColumnName(fretNum) }}</span>
                      </template>
                      <span class="text-center">開放</span>
                    </div>
                    <div class="space-y-1">
                      <div
                        v-for="stringInfo in stringRows(shape.diagram.frets)"
                        :key="stringInfo.index"
                        class="flex items-center gap-1 text-[11px]"
                      >
                        <span class="w-8 text-right text-slate-500">{{ stringInfo.stringNumber }}弦</span>
                        <div class="flex gap-1 flex-1">
                          <div
                            v-for="fretNum in visualFrets(shape)"
                            :key="`${stringInfo.index}-${fretNum}`"
                            class="flex-1 relative h-10 rounded border border-slate-800 bg-slate-950/60 flex items-center justify-center"
                          >
                            <span class="text-[10px] text-slate-500">{{ noteNameForString(stringInfo.index, fretNum) }}</span>
                            <span
                              v-if="stringInfo.fret === fretNum"
                              class="absolute inset-0 m-auto h-5 w-5 rounded-full bg-emerald-400/80 border border-emerald-700"
                            ></span>
                          </div>
                          <div class="w-12 text-center py-1 rounded border border-slate-800 bg-slate-900/60">
                            {{ fretNoteLabel(stringInfo.index, stringInfo.fret) }}
                          </div>
                        </div>
                      </div>
                    </div>
                    <p class="text-[10px] text-slate-400">丸印は押さえるポジション、右端は開放 / ミュートの状態です。</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="p-4 rounded-lg bg-slate-900 border border-slate-800 space-y-3">
        <h2 class="text-xl font-semibold flex items-center gap-2">
          <span class="w-2 h-2 bg-amber-400 rounded-full"></span> コード追加
        </h2>
        <div class="flex flex-wrap gap-2 mb-3">
          <button
            v-for="note in rootNotes"
            :key="note"
            :class="[
              'px-3 py-2 rounded border text-sm transition',
              scaleNotesSet.has(note) ? 'bg-emerald-900/50 border-emerald-500/50 text-emerald-100' : 'bg-slate-800 border-slate-700'
            ]"
            @click="newChord.root = note"
          >
            {{ note }}
          </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <label class="space-y-1">
            <p class="text-xs text-slate-400">ルート</p>
            <select v-model="newChord.root" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2">
              <option v-for="note in rootNotes" :key="note" :value="note">{{ note }}</option>
            </select>
          </label>
          <label class="space-y-1">
            <p class="text-xs text-slate-400">コードタイプ</p>
            <select v-model="newChord.quality" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2">
              <option v-for="quality in chordQualities" :key="quality" :value="quality">{{ quality }}</option>
            </select>
          </label>
          <label class="space-y-1">
            <p class="text-xs text-slate-400">オンベース（任意）</p>
            <select v-model="newChord.bass" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2">
              <option value="">（なし）</option>
              <option v-for="note in rootNotes" :key="note" :value="note">{{ note }}</option>
            </select>
          </label>
        </div>
        <div class="flex gap-3">
          <button @click="addChord" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded shadow">コード追加</button>
        </div>
        <p class="text-xs text-slate-400">スケールに含まれる音は緑でハイライトされます。</p>
      </section>

      <section class="p-4 rounded-lg bg-slate-900 border border-slate-800 space-y-3">
        <h2 class="text-xl font-semibold flex items-center gap-2">
          <span class="w-2 h-2 bg-emerald-400 rounded-full"></span> スケール設定
        </h2>
        <div class="grid grid-cols-2 gap-3">
          <label class="space-y-1">
            <p class="text-xs text-slate-400">キー</p>
            <select v-model="selectedKey" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2">
              <option v-for="note in rootNotes" :key="note" :value="note">{{ note }}</option>
            </select>
          </label>
          <label class="space-y-1">
            <p class="text-xs text-slate-400">スケールタイプ</p>
            <select v-model="selectedMode" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2">
              <option v-for="mode in modes" :key="mode" :value="mode">{{ mode }}</option>
            </select>
          </label>
        </div>
        <div class="space-y-2">
          <p class="text-xs text-slate-400">ダイアトニックコード</p>
          <div class="flex flex-col gap-2">
            <div
              v-for="(chord, idx) in diatonicChords"
              :key="idx"
              class="p-3 rounded border border-slate-800 bg-slate-800/70 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2"
            >
              <div class="flex items-baseline gap-3">
                <span class="text-sm font-semibold text-slate-100 w-10">{{ chord.degree }}</span>
                <div>
                  <p class="text-sm text-emerald-300 font-semibold leading-none">{{ chord.name }}</p>
                  <p class="text-xs text-slate-400">{{ chord.note }}</p>
                </div>
              </div>
              <span class="inline-flex w-fit px-3 py-1 rounded-full bg-slate-700 text-[11px] text-amber-200 border border-slate-600">
                {{ chord.role }}
              </span>
            </div>
          </div>
        </div>
      </section>

      <section class="p-4 rounded-lg bg-slate-900 border border-slate-800">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <span class="w-2 h-2 bg-indigo-400 rounded-full"></span> コードフォーム管理
          </h2>
          <button
            @click="openShapeDialog()"
            class="px-3 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded text-sm"
          >
            新規フォーム
          </button>
        </div>
        <p class="text-sm text-slate-400 mb-3">指板上の押さえ方を登録しておくと、進行のカード内でいつでも確認・編集できます。</p>
        <div v-if="shapes.length === 0" class="text-sm text-slate-400">まだフォームがありません。</div>
        <div v-else class="grid md:grid-cols-2 gap-3">
          <div
            v-for="shape in shapes"
            :key="shape.id"
            class="p-3 rounded border border-slate-800 bg-slate-800/70 space-y-2"
          >
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs text-slate-400">コード</p>
                <p class="text-lg font-semibold">{{ shape.chord }}</p>
              </div>
              <button
                class="px-3 py-1 text-sm rounded bg-amber-500/80 text-slate-900"
                @click="editShape(shape)"
              >
                編集
              </button>
            </div>
            <p class="text-sm text-slate-300">{{ shape.position || 'ポジション未設定' }}</p>
            <div class="flex justify-between text-xs text-slate-400">
              <span>開始フレット: {{ shape.diagram.startFret }}F</span>
              <span>フォーム ID: {{ shape.id }}</span>
            </div>
            <div class="grid grid-cols-6 gap-1">
              <div
                v-for="stringInfo in stringRows(shape.diagram.frets)"
                :key="stringInfo.index"
                class="flex flex-col items-center gap-1"
              >
                <span class="text-[10px] text-slate-500">{{ stringInfo.stringNumber }}弦</span>
                <span class="w-full text-center py-1 text-xs rounded bg-slate-950 border border-slate-700">
                  {{ fretNoteLabel(stringInfo.index, stringInfo.fret) }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="p-4 rounded-lg bg-slate-900 border border-slate-800">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold">保存済み進行</h2>
          <button @click="fetchProgressions" class="text-sm px-3 py-2 bg-slate-800 border border-slate-700 rounded">再読み込み</button>
        </div>
        <div v-if="savedProgressions.length === 0" class="text-sm text-slate-400">保存済みの進行はまだありません。</div>
        <div v-else class="space-y-2">
          <div
            v-for="prog in savedProgressions"
            :key="prog.id"
            class="flex flex-wrap items-center justify-between gap-3 p-3 rounded border border-slate-800 bg-slate-800/70"
          >
            <div>
              <p class="font-semibold">{{ prog.name }}</p>
              <p class="text-xs text-slate-400">{{ prog.scale.key }} {{ prog.scale.mode }} / {{ prog.chords.length }} コード</p>
            </div>
            <div class="flex gap-2 text-sm">
              <button @click="loadProgression(prog)" class="px-3 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded">読み込み</button>
              <button @click="deleteProgression(prog.id)" class="px-3 py-2 bg-rose-600 hover:bg-rose-500 text-white rounded">削除</button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <div
      v-if="showEditDialog"
      class="fixed inset-0 z-20 flex items-center justify-center bg-black/60 px-4"
      role="dialog"
      aria-modal="true"
    >
      <div class="w-full max-w-md p-6 rounded-lg bg-slate-900 border border-slate-800 space-y-4 shadow-xl">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">コードを編集</h3>
          <button @click="cancelEdit" class="text-slate-400 hover:text-white">✕</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <label class="space-y-1">
            <p class="text-xs text-slate-400">ルート</p>
            <select v-model="editForm.root" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2">
              <option v-for="note in rootNotes" :key="note" :value="note">{{ note }}</option>
            </select>
          </label>
          <label class="space-y-1">
            <p class="text-xs text-slate-400">コードタイプ</p>
            <select v-model="editForm.quality" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2">
              <option v-for="quality in chordQualities" :key="quality" :value="quality">{{ quality }}</option>
            </select>
          </label>
          <label class="space-y-1">
            <p class="text-xs text-slate-400">オンベース（任意）</p>
            <select v-model="editForm.bass" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2">
              <option value="">（なし）</option>
              <option v-for="note in rootNotes" :key="note" :value="note">{{ note }}</option>
            </select>
          </label>
        </div>
        <div class="flex justify-end gap-3">
          <button @click="cancelEdit" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded">キャンセル</button>
          <button @click="applyEdit" class="px-4 py-2 bg-amber-500 hover:bg-amber-400 text-slate-900 rounded">更新</button>
        </div>
      </div>
    </div>

    <div
      v-if="showShapeDialog"
      class="fixed inset-0 z-30 flex items-center justify-center bg-black/70 px-4"
      role="dialog"
      aria-modal="true"
    >
      <div class="w-full max-w-2xl p-6 rounded-lg bg-slate-900 border border-slate-800 space-y-4 shadow-xl">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">コードフォームを{{ editingShapeId ? '編集' : '登録' }}</h3>
          <button @click="closeShapeDialog" class="text-slate-400 hover:text-white">✕</button>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
          <label class="space-y-1">
            <p class="text-xs text-slate-400">コード名</p>
            <input v-model="shapeForm.chord" type="text" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" placeholder="例: Cmaj7" />
          </label>
          <label class="space-y-1">
            <p class="text-xs text-slate-400">ポジション（任意）</p>
            <input v-model="shapeForm.position" type="text" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2" placeholder="1フレット付近 など" />
          </label>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-start">
          <label class="space-y-1 md:col-span-1">
            <p class="text-xs text-slate-400">開始フレット</p>
            <input
              v-model.number="shapeForm.startFret"
              type="number"
              min="1"
              class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
            />
          </label>
          <div class="md:col-span-3 space-y-2">
            <p class="text-xs text-slate-400">指板をクリックして押さえるポジションを指定（0列で開放 / ミュート切替）</p>
            <div class="overflow-x-auto">
              <div class="min-w-[520px] space-y-2">
                <div class="grid grid-cols-6 gap-2 text-[11px] text-slate-400">
                  <span class="text-right pr-1">弦</span>
                  <template v-for="fretNum in editableFrets()" :key="`head-${fretNum}`">
                    <span class="text-center">{{ fretNum === 0 ? '開放/ミュート' : fretColumnName(fretNum) }}</span>
                  </template>
                </div>
                <div
                  v-for="stringInfo in stringRows(shapeForm.frets)"
                  :key="stringInfo.index"
                  class="grid grid-cols-6 gap-2 items-center"
                >
                  <span class="text-right text-slate-500 text-[11px]">{{ stringInfo.stringNumber }}弦</span>
                  <template v-for="fretNum in editableFrets()" :key="`${stringInfo.index}-${fretNum}`">
                    <button
                      type="button"
                      class="h-10 rounded border text-sm transition flex items-center justify-center"
                      :class="[
                        fretNum === 0 ? 'bg-slate-800/80 border-slate-700' : 'bg-slate-900/70 border-slate-800',
                        isSelectedFret(stringInfo.index, fretNum)
                          ? 'ring-2 ring-emerald-400/80 border-emerald-400 bg-emerald-900/50 text-emerald-50'
                          : 'hover:bg-slate-800'
                      ]"
                      @click="selectFret(stringInfo.index, fretNum)"
                    >
                      <span v-if="fretNum === 0">{{ openMuteLabel(stringInfo.index) }}</span>
                      <span v-else class="text-[11px]">{{ noteNameForString(stringInfo.index, fretNum) }}</span>
                    </button>
                  </template>
                </div>
              </div>
            </div>
            <p class="text-xs text-slate-400">開放弦は0、ミュートは×として保存されます。</p>
          </div>
        </div>
        <div class="flex items-center justify-between">
          <button
            v-if="editingShapeId"
            @click="deleteShape"
            class="px-3 py-2 bg-rose-600 hover:bg-rose-500 text-white rounded text-sm"
          >
            このフォームを削除
          </button>
          <span v-else></span>
          <div class="flex gap-3">
            <button @click="closeShapeDialog" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded">キャンセル</button>
            <button @click="submitShape" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded">保存</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue;
    const rootNotes = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];
    const chromaticNotes = [
      "C",
      "C#/Db",
      "D",
      "D#/Eb",
      "E",
      "F",
      "F#/Gb",
      "G",
      "G#/Ab",
      "A",
      "A#/Bb",
      "B",
    ];
    const noteIndexMap = {
      C: 0,
      "C#": 1,
      Db: 1,
      D: 2,
      "D#": 3,
      Eb: 3,
      E: 4,
      F: 5,
      "F#": 6,
      Gb: 6,
      G: 7,
      "G#": 8,
      Ab: 8,
      A: 9,
      "A#": 10,
      Bb: 10,
      B: 11,
    };
    const standardTuning = ["E", "A", "D", "G", "B", "E"];
    const scalePatterns = {
      "メジャー": [2, 2, 1, 2, 2, 2, 1],
      "ナチュラルマイナー": [2, 1, 2, 2, 1, 2, 2],
      "ハーモニックマイナー": [2, 1, 2, 2, 1, 3, 1],
      "メロディックマイナー": [2, 1, 2, 2, 2, 2, 1],
    };
    const romanDegrees = ["I", "II", "III", "IV", "V", "VI", "VII"];
    const diatonicQualities = {
      "メジャー": ["", "m", "m", "", "", "m", "dim"],
      "ナチュラルマイナー": ["m", "dim", "", "m", "m", "", ""],
      "ハーモニックマイナー": ["m", "dim", "aug", "m", "", "", "dim"],
      "メロディックマイナー": ["m", "m", "aug", "", "", "dim", "dim"],
    };
    const diatonicRoles = {
      "メジャー": [
        "トニック",
        "サブドミナント",
        "トニック",
        "サブドミナント",
        "ドミナント",
        "トニック",
        "ドミナント",
      ],
      "ナチュラルマイナー": [
        "トニック",
        "サブドミナント",
        "トニック",
        "サブドミナント",
        "ドミナント",
        "トニック",
        "サブドミナント",
      ],
      "ハーモニックマイナー": [
        "トニック",
        "サブドミナント",
        "トニック",
        "サブドミナント",
        "ドミナント",
        "サブドミナント",
        "ドミナント",
      ],
      "メロディックマイナー": [
        "トニック",
        "サブドミナント",
        "トニック",
        "サブドミナント",
        "ドミナント",
        "トニック",
        "ドミナント",
      ],
    };

    createApp({
      data() {
        return {
          rootNotes,
          modes: Object.keys(scalePatterns),
          selectedKey: "C",
          selectedMode: "メジャー",
          chordQualities: ["", "m", "dim", "aug", "7", "maj7", "m7", "sus2", "sus4", "add9", "9"],
          newChord: { root: "C", quality: "", bass: "" },
          chords: [],
          progressionName: "",
          savedProgressions: [],
          editingIndex: null,
          currentProgressionId: "",
          showEditDialog: false,
          editForm: { root: "C", quality: "", bass: "" },
          shapes: [],
          showShapeDialog: false,
          editingShapeId: "",
          shapeForm: { chord: "", position: "", startFret: 1, frets: ["x", "x", "x", "x", "x", "x"] },
        };
      },
      computed: {
        scaleNotes() {
          const startIndex = this.rootNotes.indexOf(this.selectedKey);
          const pattern = scalePatterns[this.selectedMode] || [];
          const notes = [this.selectedKey];
          let cursor = startIndex;
          pattern.forEach((step) => {
            cursor = (cursor + step) % this.rootNotes.length;
            notes.push(this.rootNotes[cursor]);
          });
          return notes.slice(0, 7);
        },
        scaleNotesSet() {
          return new Set(this.scaleNotes);
        },
        diatonicChords() {
          const qualities = diatonicQualities[this.selectedMode] || [];
          const roles = diatonicRoles[this.selectedMode] || [];
          return this.scaleNotes.map((note, idx) => {
            const quality = qualities[idx] || "";
            return {
              degree: this.degreeName(idx, quality),
              name: this.buildLabel(note, quality),
              note,
              quality,
              role: roles[idx] || "機能未設定",
            };
          });
        },
      },
      methods: {
        buildLabel(root, quality, bass = "") {
          const base = !quality || quality === "maj" ? root : `${root}${quality}`;
          if (!bass) return base;
          return `${base}/${bass}`;
        },
        degreeName(index, quality) {
          const base = romanDegrees[index] || `(${index + 1})`;
          if (quality === "m") return `${base}m`;
          if (quality === "dim") return `${base}dim`;
          if (quality === "aug") return `${base}aug`;
          return base;
        },
        defaultShapeForm(chord = "") {
          return { chord, position: "", startFret: 1, frets: ["x", "x", "x", "x", "x", "x"] };
        },
        fretColumnName(fretNumber) {
          return this.noteNameForString(0, fretNumber);
        },
        fretNoteLabel(stringIndex, value) {
          const fretValue = this.parseFretValue(value);
          if (fretValue === -1) return "ミュート";
          if (fretValue === 0) return this.noteNameForString(stringIndex, 0);
          return this.noteNameForString(stringIndex, fretValue);
        },
        noteNameForString(stringIndex, fretNumber) {
          const base = standardTuning[stringIndex] || "E";
          const baseIndex = noteIndexMap[base] ?? 0;
          const offset = Math.max(0, Number(fretNumber) || 0);
          const index = (baseIndex + offset) % chromaticNotes.length;
          return chromaticNotes[index];
        },
        visualFrets(shape) {
          const start = Math.max(1, shape.diagram?.startFret || 1);
          return Array.from({ length: 4 }, (_, idx) => start + idx);
        },
        stringRows(frets = []) {
          return (frets || [])
            .map((fret, idx) => ({ stringNumber: 6 - idx, fret, index: idx }))
            .reverse();
        },
        editableFrets() {
          const start = Math.max(1, Number(this.shapeForm.startFret) || 1);
          return [0, ...Array.from({ length: 4 }, (_, idx) => start + idx)];
        },
        isSelectedFret(stringIndex, fretNumber) {
          const current = this.parseFretValue(this.shapeForm.frets[stringIndex]);
          return current === fretNumber;
        },
        openMuteLabel(stringIndex) {
          const current = this.parseFretValue(this.shapeForm.frets[stringIndex]);
          if (current === 0) return `${this.noteNameForString(stringIndex, 0)} (開放)`;
          if (current === -1) return "ミュート";
          return "未設定";
        },
        selectFret(stringIndex, fretNumber) {
          if (fretNumber === 0) {
            const current = this.parseFretValue(this.shapeForm.frets[stringIndex]);
            this.shapeForm.frets[stringIndex] = current === 0 ? "x" : "0";
            return;
          }
          this.shapeForm.frets[stringIndex] = `${fretNumber}`;
        },
        shapesForLabel(label) {
          return this.shapes.filter((shape) => shape.chord === label);
        },
        parseFretValue(raw) {
          const text = String(raw ?? "").trim().toLowerCase();
          if (text === "" || text === "x") return -1;
          const num = Number(text);
          return Number.isFinite(num) ? Math.trunc(num) : -1;
        },
        shapePayload() {
          return {
            chord: this.shapeForm.chord.trim() || "無題のコード",
            position: this.shapeForm.position.trim(),
            diagram: {
              startFret: Math.max(1, Number(this.shapeForm.startFret) || 1),
              frets: this.shapeForm.frets.map((f) => this.parseFretValue(f)),
            },
          };
        },
        addChord() {
          const label = this.buildLabel(this.newChord.root, this.newChord.quality, this.newChord.bass);
          this.chords.push({ ...this.newChord, label });
          this.newChord = { root: this.selectedKey, quality: this.newChord.quality, bass: "" };
        },
        removeChord(index) {
          this.chords.splice(index, 1);
          if (this.chords.length === 0) {
            this.currentProgressionId = "";
          }
          if (this.editingIndex === index) {
            this.cancelEdit();
          }
        },
        moveChord(index, direction) {
          const target = index + direction;
          if (target < 0 || target >= this.chords.length) return;
          const temp = this.chords[target];
          this.chords[target] = this.chords[index];
          this.chords[index] = temp;
        },
        startEdit(index) {
          this.editingIndex = index;
          const chord = this.chords[index];
          this.editForm = { root: chord.root, quality: chord.quality, bass: chord.bass || "" };
          this.showEditDialog = true;
        },
        applyEdit() {
          if (this.editingIndex === null) return;
          const label = this.buildLabel(this.editForm.root, this.editForm.quality, this.editForm.bass);
          this.chords.splice(this.editingIndex, 1, { ...this.editForm, label });
          this.cancelEdit();
        },
        cancelEdit() {
          this.showEditDialog = false;
          this.editingIndex = null;
          this.editForm = { root: this.selectedKey, quality: "", bass: "" };
        },
        degreeLabel(chord) {
          const idx = this.scaleNotes.indexOf(chord.root);
          if (idx < 0) return "スケール外";
          return `ディグリー: ${this.degreeName(idx, chord.quality)}`;
        },
        progressionPayload() {
          return {
            name: this.progressionName || "無題の進行",
            scale: { key: this.selectedKey, mode: this.selectedMode },
            chords: this.chords,
          };
        },
        async saveProgression() {
          if (this.chords.length === 0) {
            alert("コードを追加してください。");
            return;
          }
          const payload = this.progressionPayload();
          const url = this.currentProgressionId ? `/api/progressions/${this.currentProgressionId}` : "/api/progressions";
          const method = this.currentProgressionId ? "PUT" : "POST";
          const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            alert("保存に失敗しました。");
            return;
          }
          const data = await res.json();
          this.currentProgressionId = data.id;
          this.progressionName = data.name;
          await this.fetchProgressions();
        },
        async fetchProgressions() {
          const res = await fetch("/api/progressions");
          if (res.ok) {
            this.savedProgressions = await res.json();
          }
        },
        loadProgression(prog) {
          this.selectedKey = prog.scale.key;
          this.selectedMode = prog.scale.mode;
          this.chords = prog.chords;
          this.progressionName = prog.name;
          this.currentProgressionId = prog.id;
          this.cancelEdit();
        },
        async deleteProgression(id) {
          if (!confirm("削除してよろしいですか？")) return;
          const res = await fetch(`/api/progressions/${id}`, { method: "DELETE" });
          if (res.ok) {
            if (this.currentProgressionId === id) {
              this.resetProgression();
            }
            await this.fetchProgressions();
          }
        },
        resetProgression() {
          this.chords = [];
          this.progressionName = "";
          this.currentProgressionId = "";
          this.editingIndex = null;
          this.showEditDialog = false;
        },
        async fetchShapes() {
          const res = await fetch("/api/shapes");
          if (res.ok) {
            this.shapes = await res.json();
          }
        },
        openShapeDialog(chordLabel = "") {
          this.shapeForm = this.defaultShapeForm(chordLabel);
          this.editingShapeId = "";
          this.showShapeDialog = true;
        },
        closeShapeDialog() {
          this.shapeForm = this.defaultShapeForm();
          this.editingShapeId = "";
          this.showShapeDialog = false;
        },
        editShape(shape) {
          this.editingShapeId = shape.id;
          const frets = (shape.diagram?.frets || []).map((f) => (f === -1 ? "x" : `${f}`));
          this.shapeForm = {
            chord: shape.chord,
            position: shape.position || "",
            startFret: shape.diagram?.startFret || 1,
            frets: frets.length === 6 ? frets : this.defaultShapeForm(shape.chord).frets,
          };
          this.showShapeDialog = true;
        },
        async submitShape() {
          const payload = this.shapePayload();
          const hasDiagram = Array.isArray(payload.diagram.frets) && payload.diagram.frets.length === 6;
          if (!hasDiagram) {
            alert("6弦分のフレットを入力してください。");
            return;
          }
          const url = this.editingShapeId ? `/api/shapes/${this.editingShapeId}` : "/api/shapes";
          const method = this.editingShapeId ? "PUT" : "POST";
          const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            alert("フォームの保存に失敗しました。");
            return;
          }
          await this.fetchShapes();
          this.closeShapeDialog();
        },
        async deleteShape() {
          if (!this.editingShapeId) return;
          if (!confirm("このフォームを削除しますか？")) return;
          const res = await fetch(`/api/shapes/${this.editingShapeId}`, { method: "DELETE" });
          if (res.ok) {
            await this.fetchShapes();
            this.closeShapeDialog();
          }
        },
      },
      mounted() {
        this.fetchProgressions();
        this.fetchShapes();
      },
    }).mount("#app");
  </script>
</body>
</html>
